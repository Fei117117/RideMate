<!DOCTYPE html>
<html>

<head>
    <title>Map</title>
    <link rel="stylesheet" href="../static/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places,geometry,visualization"></script>
    <script src="../static/script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script>
        // Google Map API function
        function initMap() {

            // Set up the map options. Used in javascript to control position of the mapTypeControl       
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: {{ lat }}, lng: {{ lng }}},
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_CENTER
                }
            });

            var markers = {{ markers| tojson }};
            console.log(markers);  // Print the markers array in the console
            
            var mapMarkers = [];


            for (var i = 0; i < markers.length; i++) {
                var marker = markers[i];
                var newMarker = new google.maps.Marker({
                    position: marker.position,
                    title: marker.title,
                    map: map
                });
                // Add the new marker to the mapMarkers array
                mapMarkers.push(newMarker);
                // Add the event listeners to each marker
                attachInfoWindow(newMarker, map, marker);
            }
            

            function attachInfoWindow(marker, map, markerData) {
                var infoWindow = new google.maps.InfoWindow({
                    content: '<div><strong>' + markerData.title + '</strong>' +
                        '<div><i class="wi wi-wmo4680-' + markerData.weathercode + '"></i></div>' +
                        '<div>Status: ' + markerData.status + '</div>' +
                        '<div>Available stands: ' + markerData.bike_stands + '</div>' +
                        '<div>Available bikes: ' + markerData.available_bikes + '</div></div>'+
                        '<div>Banking: ' + (markerData.banking ? 'Yes' : 'No') + '</div></div>'

                });

                marker.addListener('mouseover', function () {
                    infoWindow.open(map, this);
                });

                marker.addListener('mouseout', function () {
                    infoWindow.close();
                });

                marker.addListener('click', function () {
                    document.getElementById('side-bar-right').style.width= '350px';
                    document.getElementById('side-bar-right').style.display = 'flex';
                    document.getElementById('close-icon-right').style.display = 'block';
                    // Showing station average chart
                    google.charts.load('current', {'packages':['corechart']});
                    google.charts.setOnLoadCallback(drawDaily);
                    google.charts.setOnLoadCallback(drawTemperature);

                    // Functions to draw station average chart    
                    // Make a request to the Open Meteo API to get the weather
                    var weatherUrl = "https://api.open-meteo.com/v1/forecast?latitude="+markerData.position.lat+
                        "&longitude="+markerData.position.lng+
                        "&hourly=temperature_2m,precipitation_probability,weathercode,windspeed_10m"+
                        "&daily=weathercode,temperature_2m_max,temperature_2m_min"+
                        "&current_weather=true&timeformat=unixtime&timezone=Europe/London";

                    // Extract the current weather from the JSON object
                    fetch(weatherUrl)
                    .then(response => response.json())
                    .then(data => data.current_weather) 
                    .then(data => {
                        //User weather code to show the corresponding image
                        var weatherCode = data.weathercode;
                        console.log("Weather Code: " + weatherCode);
                        var weatherCodeOut ='<img src="../static/weather/' + weatherCode + '.png" height="30">';
                        document.getElementById('weather-icon').innerHTML = weatherCodeOut;

                        //Show weather text (temperature, windspeed)
                        var temperature = data.temperature;
                        var windSpeed = data.windspeed;
                        console.log("Temperature: " + temperature);
                        var weatherTextOut = '<p>Temperature: '+temperature+'&#8451;</p>'+
                                            '<p>Windspeed: '+windSpeed+' km/h</p>';
                        document.getElementById('weather-text').innerHTML = weatherTextOut;
                    }); 

                    // Draw chart of Temperature, Precipitation, And Windspeed

                    function drawTemperature() {
                        // const data = await getWeather();
                        fetch(weatherUrl)
                        .then(response => response.json())
                        .then(data => data.hourly) 
                        .then(data => {
                            // Get times from API
                            var times = data.time;

                            // Get temperature, precipitation, and windspeed
                            var temperatures = data.temperature_2m;
                            var precipitations = data.precipitation_probability;
                            var windspeeds = data.windspeed_10m;

                            // Headings for data to pass into google chart
                            var tempChartData = [['Time','Temperature']];
                            var preciChartData = [['Time','Precipitation']];
                            var windChartData = [['Time','Wind Speed']];
                            
                            // Only show future data
                            for(var i = 0; i < times.length; i++){
                                if(times[i] >= Math.floor(Date.now() / 1000)){
                                    const timeToDate = new Date(times[i] * 1000); // convert Unix timestamp to milliseconds and create Date object
                                    // Add temperature to the temperature data array
                                    var tempdatapoint = [timeToDate,temperatures[i]];
                                    tempChartData.push(tempdatapoint);
                                    // Add precipitation to the precipitations data array
                                    var precidatapoint = [timeToDate,precipitations[i]];
                                    preciChartData.push(precidatapoint);
                                    // Add windspeed to the windspeed data array
                                    var winddatapoint = [timeToDate,windspeeds[i]];
                                    windChartData.push(winddatapoint);
                                }
                            }

                            console.log(tempChartData);
                            console.log(preciChartData);
                            console.log(windChartData);

                            // Create google data tables from 3 data arrays
                            var tempData = google.visualization.arrayToDataTable(tempChartData);
                            var preciData = google.visualization.arrayToDataTable(preciChartData);
                            var windData = google.visualization.arrayToDataTable(windChartData);

                            // Format the charts
                            var options = {
                                chartArea: {
                                    width: '85%'
                                },
                                hAxis: {
                                    viewWindow: {
                                        min: new Date(Date.now()),
                                        max: new Date(Date.now()+24*60*60*1000)
                                    },
                                    gridlines: {
                                        count: -1,
                                        units: {
                                            days: {format: ['MMM dd']},
                                            hours: {format: ['HH:mm', 'ha']},
                                            },
                                        color: '#fff'
                                    },
                                    baselineColor:'#fff'
                                },
                                vAxis: {
                                    minValue: 0,
                                    gridlines: {
                                        color: '#fff'
                                    },
                                },
                                width:350,
                                height:150,
                                legend: 'none',
                                series: {
                                    0: { color: '#FF4500' }
                                }
                            };

                            // Draw the charts
                            var tempChart = new google.visualization.AreaChart(document.getElementById('temperature-chart'));
                            tempChart.draw(tempData, options);

                            var preciChart = new google.visualization.ColumnChart(document.getElementById('precipitation-chart'));
                            preciChart.draw(preciData, options);

                            var windChart = new google.visualization.LineChart(document.getElementById('wind-chart'));
                            windChart.draw(windData, options);
                        });                         
                    } 

                    function drawDaily(){
                        url = "/available/"+markerData.number;
                        fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            var dayAverageData = [['Day of week', 'Average daily available bikes', 'Average daily free stands']];
                            for (var i = 0; i < data.length; i++){
                                var datapoint = [data[i]['day_name'],data[i]['avg_bikes'],data[i]['avg_stands']];
                                dayAverageData.push(datapoint);
                            }
                            console.log(dayAverageData);                        
                            var dayData = google.visualization.arrayToDataTable(dayAverageData);

                            var options = {
                                chartArea: {
                                    width: '85%'
                                },
                                width: 350,
                                height: 200,
                                seriesType: 'bars',
                                legend:{position: 'top', textStyle: {fontSize: 9} },
                                series: {
                                    0: { color: '#003fff'},
                                    1: { color: '#00ffff' }        
                                },
                                vAxis: {
                                    minValue: 0,
                                    gridlines: {
                                        color: '#fff'
                                    }
                                },
                            };

                        var dayChart = new google.visualization.ComboChart(document.getElementById('daily-average'));
                        dayChart.draw(dayData, options);
                        })

                    /* Show the Prediction Result*/
                    //Get the result of modle: station availability prediction 
                    async function getPredicData() {
                            const url_predict = '/predict_bikes/'+markerData.number;
                            const response_predict = await fetch(url_predict);
                            const data_predict  = await response_predict.json();
                            return data_predict;
                    }

                    function search(searchTerm, data) {
                        return data[parseInt(searchTerm)];
                    }

                    document.getElementById('search-form').addEventListener('submit', async function(event) {
                        event.preventDefault();

                        const searchTerm = document.getElementById('search_term').value;
                        const data = await getPredicData();
                        const result = search(searchTerm,data);
                        let resultHTML = '';

                        if (result) {
                            resultHTML = `
                            <div>
                                <h1><i class="material-icons" title="Available Bikes">pedal_bike</i>${result}</h1>
                            </div>
                            `;

                        } else {
                            resultHTML = '<p>No results found.</p>';
                        }

                        document.getElementById('search-results').innerHTML = resultHTML;
                        });

                    }


                });
                var heatmapData = markers.map(function(marker) {
                    return {
                        location: new google.maps.LatLng(marker.position.lat, marker.position.lng),
                        weight: marker.available_bikes
                    };
                });
            
                var heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    dissipating: true,
                    gradient: [
                        "rgba(0, 255, 255, 0)", 
                        "rgba(0, 255, 255, 1)", 
                        "rgba(0, 191, 255, 1)", 
                        "rgba(0, 127, 255, 1)", 
                        "rgba(0, 63, 255, 1)", 
                        "rgba(0, 0, 255, 1)",
                        "rgba(0, 0, 223, 1)",
                        "rgba(0, 0, 191, 1)",
                        "rgba(0, 0, 159, 1)",
                        "rgba(0, 0, 127, 1)",
                        "rgba(63, 0, 91, 1)",
                        "rgba(127, 0, 63, 1)",
                        "rgba(191, 0, 31, 1)",
                        "rgba(255, 0, 0, 1)",
                    ],
                    maxIntensity: 30, // Change this value according to the highest number of available bikes at your stations
                    radius: 30, // Adjust the radius to change the appearance of the heatmap
                    opacity: 0.5,
                });
            
                heatmap.setMap(map);
            }

            const input = document.getElementById("pac-input");            

            const autocomplete = new google.maps.places.Autocomplete(input);

            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }
            
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
            
                // Show nearest stations
                showNearestStations(place.geometry.location);
                document.getElementById('side-bar').style.display = 'block';
            });
        
        
        // var canvas = document.getElementById("temperature-chart");

            function printDebug(){console.log("Passed");}

            function findNearestStations(position) {
                let distances = markers.map((marker, index) => {
                    return {
                        index: index,
                        distance: google.maps.geometry.spherical.computeDistanceBetween(
                            position,
                            new google.maps.LatLng(marker.position.lat, marker.position.lng)
                        ),

                    };
                });
            
                distances.sort((a, b) => a.distance - b.distance);
            
                let nearestStations = distances.slice(0, 5).map((item) => markers[item.index]);
            
                return nearestStations;
            }

            function showNearestStations(location) {
                let nearestStations = findNearestStations(location);
                console.log(nearestStations); // log nearest stations to the console
                let sidebar = document.getElementById("side-bar");
                sidebar.style.height = '70%';
                document.getElementById('close-icon').style.display = 'block';
                let nearestStationsDiv = document.getElementById("nearest-stations");
                nearestStationsDiv.innerHTML = "<h3>Nearest Stations:</h3>";
                nearestStations.forEach((station) => {
                    let stationDiv = document.createElement("div");
                    stationDiv.innerHTML = `<h4>${station.title}</h4>
                        <p><i class="material-icons" title="Status">info</i>${station.status}</p>
                        <p><i class="material-icons" title="Available Bikes">directions_bike</i>${station.available_bikes}</p>
                        <p><i class="material-icons" title="Available Stands">directions_walk</i>${station.bike_stands}</p>
                        <p><i class="material-icons" title="Banking">${station.banking ? 'check_circle' : 'cancel'}</i>${station.banking ? 'Yes' : 'No'}</p>`;
                    stationDiv.style.cursor = 'pointer';
                    stationDiv.addEventListener('click', () => {
                        let marker = mapMarkers.find(m => m.title === station.title);
                    
                        // Make the existing marker bounce
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                        setTimeout(() => { marker.setAnimation(null); }, 750);
                    });
                    
                    nearestStationsDiv.appendChild(stationDiv);
                });
            };
        

    </script>
</head>

<body onload="initMap()">
    {# If possible, please keep the html id and CSS like this #}  
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    <div id="side-bar">
        <div id="pac-container">
            <form id="pac-form">
                <input id="pac-input" type="text" placeholder="Enter a location" />
            </form>
        </div>
        <div id="nearest-stations">
            <!-- Nearest stations will be displayed here -->
        </div>
        <div id="close-side">
            <i id="close-icon" class="material-icons" onclick="closeSide()" >&#xe316;</i>
        </div>
    </div>
    <div id="side-bar-right">
        <div id="close-side-right">
            <i id="close-icon-right" class="material-icons" onclick="closeSideRight()" >&#xe315;</i>
        </div>
        <div id="side-bar-info">
            <div id="weather-current">
                <div id="weather-icon">Hello</div>
                <div id="weather-text">
                    <p>Temperature: 0&#8451;</p>
                    <p>Windspeed: 100km/h</p>
                </div>
                <div id=""></div>
            </div>
            <div id="weather-hour">
                <div class="tab">
                    <button class="tablinks active" onclick="openWeather(event, 'temperature-chart')">Temperature(&#8451;)</button>
                    <button class="tablinks" onclick="openWeather(event, 'precipitation-chart')">Precipitation(%)</button>
                    <button class="tablinks" onclick="openWeather(event, 'wind-chart')">Windspeed(km/h)</button>
                </div>
                <div id="temperature-chart" class="tabcontent"></div>
                <div id="precipitation-chart" class="tabcontent"></div>
                <div id="wind-chart" class="tabcontent"></div>
                
            </div>
            <div id="station-history">
                <div id="daily-average"></div>
            </div>
            <div id="station-prediction">
                <h3 class="sidebar-label"><i class="sidebar-icon clock material-icons">my_location</i>Station Prediction</h3>
                <form id="search-form">
                    <label for="search_term">Select a time:</label>
                    <select id="search_term" name="time">
                        {% for i in range(24) %}
                        <option value="{{ i }}">{{ "%02d:00" % i }}</option>
                        {% endfor %}
                    </select>
                    <!-- <label for="search_term">Search hour:</label>
                    <input type="number" id="search_term" min="1" max="24" required> -->
                    <!-- <button type="submit">Available Bikes</button> -->
                    <input type="submit" value="Available Bikes">
                </form>
                <div id="search-results"></div>
            </div>
        </div>
    </div>
    <div id="map"></div>
</body>
</html>