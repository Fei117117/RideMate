<!DOCTYPE html>
<html>

<head>
    <title>Map</title>
    <link rel="stylesheet" href="../static/style.css">
    {# <link rel="stylesheet" href="../static/weather-icons-master/css/weather-icons-wind.css"> #}
    {# <link rel="stylesheet" href="../static/weather-icons-master/css/weather-icons-wind.min.css"> #}
    {# <link rel="stylesheet" href="../static/weather-icons-master/css/weather-icons.css"> #}
    {# <link rel="stylesheet" href="../static/weather-icons-master/css/weather-icons.min.css"> #}
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places,geometry"></script>
    <script src="../static/script.js"></script>
    <script>
        // Google Map API function
        function initMap() {

            // Set up the map options. Used in javascript to control position of the mapTypeControl       
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13.75,
                center: { lat: {{ lat }}, lng: {{ lng }}},
                mapTypeControl: true,
                mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_CENTER
            }
            });

            var markers = {{ markers| tojson }};
            console.log(markers);  // Print the markers array in the console

            for (var i = 0; i < markers.length; i++) {
                var marker = markers[i];
                var newMarker = new google.maps.Marker({
                    position: marker.position,
                    title: marker.title,
                    map: map,
                });
                // Add the event listeners to each marker
                attachInfoWindow(newMarker, map, marker);
            }

            function attachInfoWindow(marker, map, markerData) {
                var infoWindow = new google.maps.InfoWindow({
                    content: '<div><strong>' + markerData.title + '</strong>' +
                        '<div><i class="wi wi-wmo4680-' + markerData.weathercode + '"></i></div>' +
                        '<div>Status: ' + markerData.status + '</div>' +
                        '<div>Available stands: ' + markerData.bike_stands + '</div>' +
                        '<div>Available bikes: ' + markerData.available_bikes + '</div></div>'+
                        '<div>Banking: ' + (markerData.banking ? 'Yes' : 'No') + '</div></div>'

                });

                marker.addListener('mouseover', function () {
                    infoWindow.open(map, this);
                });

                marker.addListener('mouseout', function () {
                    infoWindow.close();
                });
            }

            var availability_data = {{ availability| tojson }};

            function findNearestStations(position) {
                let distances = markers.map((marker, index) => {
                    return {
                        index: index,
                        distance: google.maps.geometry.spherical.computeDistanceBetween(
                            position,
                            new google.maps.LatLng(marker.position.lat, marker.position.lng)
                        ),

                    };
                });
            
                distances.sort((a, b) => a.distance - b.distance);
            
                let nearestStations = distances.slice(0, 5).map((item) => markers[item.index]);
            
                return nearestStations;
            }
            
            function showNearestStations(location, availability_data) {
                let nearestStations = findNearestStations(location);
                console.log(nearestStations); // log nearest stations to the console
                let sidebar = document.getElementById("side-bar");
                sidebar.style.height = '70%';
                document.getElementById('close-icon').style.display = 'block';
                let nearestStationsDiv = document.getElementById("nearest-stations");
                nearestStationsDiv.innerHTML = "<h3>Nearest Stations:</h3>";
                nearestStations.forEach((station) => {
                    let stationDiv = document.createElement("div");
                    stationDiv.innerHTML = `<h4>${station.title}</h4>
                        <p><i class="material-icons" title="Status">info</i>: ${station.status}</p>
                        <p><i class="material-icons" title="Available Bikes">directions_bike</i>: ${station.available_bikes}</p>
                        <p><i class="material-icons" title="Available Stands">directions_walk</i>: ${station.bike_stands}</p>
                        <p><i class="material-icons" title="Banking">${station.banking ? 'check_circle' : 'cancel'}</i>: ${station.banking ? 'Yes' : 'No'}</p>`;
                    nearestStationsDiv.appendChild(stationDiv);
                });
            }
            

            
            
            
            const input = document.getElementById("pac-input");
            
            const autocomplete = new google.maps.places.Autocomplete(input);
            
            autocomplete.bindTo("bounds", map);
            
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }
            
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
            
                // Show nearest stations
                showNearestStations(place.geometry.location, availability_data);
                document.getElementById('side-bar').style.display = 'block';
            });
            
        }
    </script>
</head>

<body onload="initMap()">
    {# If possible, please keep the html id and CSS like this #}  
    <div id="side-bar">
        <div id="pac-container">
            <form id="pac-form">
                <input id="pac-input" type="text" placeholder="Enter a location" />
            </form>
        </div>
        <div id="nearest-stations">
            <!-- Nearest stations will be displayed here -->
        </div>
        <div id="close-side">
            <i id="close-icon" class="material-icons" onclick="closeSide()">remove</i>
        </div>
    </div>
    <div id="map"></div>
</body>

</html>